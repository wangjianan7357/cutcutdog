<html>
<head>
	<meta charset="utf-8">
	<title></title>
	<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<!--标准mui.css-->
	<link rel="stylesheet" href="css/mui.min.css">
	<link rel="stylesheet" href="css/dzcss.css">
	<!--App自定义的css-->
	<style type="text/css">
		#comment-list {
			padding:10px 5px 10px 5px;;
			
			text-align: left;
			color:#666 ;
			font-size:14px ;
			margin:10px 10px ;
			
		}
		#comment-list {
			padding:0px 0px 0px 0px;;
			background-color:#fff ;
			text-align: left;
			
			color:#666 ;
			font-size:12px ;
			margin:0px 0px ;
		}
		#comment-list li {
			border-bottom: 1px  solid #f5f5f5; list-style:none ; background-color:#fbfbfb ;  padding-left: 5px;height:27px; padding-top:2px ;
		}
		#comment-list li p{color:#666 ;  font-size:12px ;}
		#comment-list li p a{color:#b8b7b7 ; font-size:12px ;}
		
		#topPopover {
			position:absolute;
			top: 16px;
			right: 6px;
		}
		#topPopover .mui-popover-arrow {
			left: auto;
			right: 6px;
		}
		p {
			text-indent: 22px;
		}
		span.mui-icon {
			font-size: 14px;
			color: #007aff;
			margin-left: -15px;
			padding-right: 10px;
		}
		.mui-popover {
			height: 150px;
		}
		#sharecontent{
	width:80%;
	-webkit-user-select:text;
	border: 1px solid #6C6C6C;
	-webkit-border-radius: 2px;
	border-radius: 2px;
}
#pic{
	width:100px;
	height:100px;
	/*border: 1px dashed #CCCCCC;*/
}
.sharehref{
	width:80%;
	-webkit-user-select:text;
	border: 1px solid #6C6C6C;
	-webkit-border-radius: 2px;
	border-radius: 2px;
	margin-bottom: .5em;
}
		
	</style>
	<script src="js/mui.min.js"></script>
	<script src="js/mui.zoom.js"></script>
	<script src="js/mui.previewimage.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/template-native.js"></script>
    <script src="js/basic.js"></script>
    <script type="text/javascript" src="js/common.js"></script>
    <script type="text/javascript">
var shares=null,bhref=false;
var Intent=null,File=null,Uri=null,main=null;
// H5 plus事件处理
function plusReady(){
	updateSerivces();
	if(plus.os.name=="Android"){
		main = plus.android.runtimeMainActivity();
		Intent = plus.android.importClass("android.content.Intent");
		File = plus.android.importClass("java.io.File");
		Uri = plus.android.importClass("android.net.Uri");
	}
}
if(window.plus){
	plusReady();
}else{
	document.addEventListener("plusready",plusReady,false);
}
/**
 * 更新分享服务
 */
function updateSerivces(){
	plus.share.getServices( function(s){
		shares={};
		for(var i in s){
			var t=s[i];
			shares[t.id]=t;
		}
	}, function(e){
		outSet( "获取分享服务列表失败："+e.message );
	} );
}
/**
 * 调用系统分享
 * 调用
 */
function shareSystem() {
	if(plus.os.name!=="Android"){
		plus.nativeUI.alert("此平台暂不支持系统分享功能!");
		return;
	}
	var intent=new Intent(Intent.ACTION_SEND);
	var p = "";
	if(pic&&pic.realUrl){
		p = pic.realUrl;
		if(p.substr(0,7)==="file://"){
			p=p.substr(7);
		}else if(p.sub(0)!=="/"){
			p=plus.io.convertLocalFileSystemURL(p);
		}
	}
	var f = new File(p);
	var uri = Uri.fromFile(f);
	if(f.exists()&&f.isFile()){
		console.log("image/*");
		intent.setType("image/*");
		intent.putExtra(Intent.EXTRA_STREAM,uri);
	}else{
		console.log("text/plain");
		intent.setType("text/plain");
	}
	intent.putExtra(Intent.EXTRA_SUBJECT,"HBuilder");
	intent.putExtra(Intent.EXTRA_TEXT,sharecontent.value);
	intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
	main.startActivity(Intent.createChooser(intent,"系统分享"));
}
/**
   * 分享操作
   * @param {JSON} sb 分享操作对象s.s为分享通道对象(plus.share.ShareService)
   * @param {Boolean} bh 是否分享链接
   */
function shareAction(sb,bh) {
	outSet( "分享操作：" );
	if(!sb||!sb.s){
		outLine( "无效的分享服务！" );
		return;
	}
	var msg={content:sharecontent.value,extra:{scene:sb.x}};
	if(bhref){
		msg.href=sharehref.value;
		if(sharehrefTitle&&sharehrefTitle.value!=""){
			msg.title=sharehrefTitle.value;
		}
		if(sharehrefDes&&sharehrefDes.value!=""){
			msg.content=sharehrefDes.value;
		}
		msg.thumbs=["_www/logo.png"];
		msg.pictures=["_www/logo.png"];
	}else{
		if(pic&&pic.realUrl){
			msg.pictures=[pic.realUrl];
		}
	}
	// 发送分享
	if ( sb.s.authenticated ) {
		outLine( "---已授权---" );
		shareMessage(msg,sb.s);
	} else {
		outLine( "---未授权---" );
		sb.s.authorize( function(){
				shareMessage(msg,sb.s);
			},function(e){
			outLine( "认证授权失败："+e.code+" - "+e.message );
		});
	}
}
/**
   * 发送分享消息
   * @param {JSON} msg
   * @param {plus.share.ShareService} s
   */
function shareMessage(msg,s){
	outLine(JSON.stringify(msg));
	s.send( msg, function(){
		outLine( "分享到\""+s.description+"\"成功！ " );
	}, function(e){
		outLine( "分享到\""+s.description+"\"失败: "+JSON.stringify(e) );
	} );
}
/**
 * 解除所有分享服务的授权
 */
function cancelAuth(){try{
	outSet( "解除授权：" );
	for ( var i in shares ) {
		var s = shares[i];
		if ( s.authenticated ) {
			outLine( "取消\""+s.description+"\"");
		}
		s.forbid();
	}
	// 取消授权后需要更新服务列表
	updateSerivces();
	outLine( "操作成功！" );}catch(e){alert(e);}
}
// 拍照添加图片分享
function shareCameraPicture(){
	outSet("拍照添加分享图片：");
	var cmr=plus.camera.getCamera();
	cmr.captureImage(function(p){
		plus.io.resolveLocalFileSystemURL(p,function(entry){
			pic.src=entry.toLocalURL();
			pic.realUrl=p;
			outLine("拍照图片："+pic.realUrl);
		},function(e){
			outLine("读取拍照文件错误："+e.message);
		} );
	},function(e){
		outLine( "拍照失败："+e.message );
	});
}
// 从相册添加图片分享
function shareGalleryPicture(){
	outSet("从相册添加分享图片：");
	plus.gallery.pick(function(p){
		// 从相册返回的路径不需要转换可以直接使用
		pic.src=p;
		pic.realUrl=pic.src;
		outLine("选择图片："+pic.realUrl);
//      plus.io.resolveLocalFileSystemURL(p,function(entry){
//			pic.src=entry.toLocalURL();
//			pic.realUrl=pic.src;
//			outLine("选择图片："+pic.realUrl);
//		},function(e){
//			outLine("读取拍照文件错误："+e.message);
//		} );
    });
}
// 使用Logo图片分享
function shareLogoPicture(){
	outSet("使用Logo分享图片：");
	var url="_www/logo.png";
	plus.io.resolveLocalFileSystemURL(url,function(entry){
		pic.src=entry.toLocalURL();
		pic.realUrl=url;
	},function(e){
		outLine("读取Logo文件错误："+e.message);
	} );
}
// 打开分享
function shareShow(){
	var shareBts=[];
	// 更新分享列表
	var ss=shares['weixin'];
	ss&&ss.nativeClient&&(shareBts.push({title:'微信朋友圈',s:ss,x:'WXSceneTimeline'}),
	shareBts.push({title:'微信好友',s:ss,x:'WXSceneSession'}));
	ss=shares['sinaweibo'];
	ss&&shareBts.push({title:'新浪微博',s:ss});
	ss=shares['qq'];
	ss&&ss.nativeClient&&shareBts.push({title:'QQ',s:ss});
	// 弹出分享列表
	shareBts.length>0?plus.nativeUI.actionSheet({title:'分享',cancel:'取消',buttons:shareBts},function(e){
		(e.index>0)&&shareAction(shareBts[e.index-1],false);
	}):plus.nativeUI.alert('当前环境无法支持分享操作!');
}
// 分析链接
function shareHref(){
	var shareBts=[];
	// 更新分享列表
	var ss=shares['weixin'];
	ss&&ss.nativeClient&&(shareBts.push({title:'微信朋友圈',s:ss,x:'WXSceneTimeline'}),
	shareBts.push({title:'微信好友',s:ss,x:'WXSceneSession'}));
	ss=shares['qq'];
	ss&&ss.nativeClient&&shareBts.push({title:'QQ',s:ss});
	// 弹出分享列表
	shareBts.length>0?plus.nativeUI.actionSheet({title:'分享链接',cancel:'取消',buttons:shareBts},function(e){
		(e.index>0)&&shareAction(shareBts[e.index-1],true);
	}):plus.nativeUI.alert('当前环境无法支持分享链接操作!');
}
		</script>
</head>

<body>
	<header class="mui-bar mui-bar-nav">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"><img src="images/home.png"></a>
	    <h1 class="mui-title"><img src="images/Petchat.png"> <img src="images/CatDog.png"></h1>
	    <a id="menu" class="mui-action-menu mui-icon mui-icon-bars mui-pull-right" style=" color:#333 ; font-weight: bold;" href="#topPopover"></a>
	</header>
	
	<div class="mui-content" style=" padding-bottom:20px ; background:none ; background-color:#fff ;">
		<div class="discuss-title" data-info="detail.name"></div>
		<div style=" padding-left:10px ; overflow: hidden;">
			<div class="discuss-zi-wz">來自：<span data-info="detail.catalog.name"></span></div>
			<div class="discuss-zi-wz-flo">
				<div style="float: left;">
				<span class="mui-icon mui-icon-chat" style="color: #b8e5fa; font-size:12px ;">
					<a style=" color:#a9a9a9 ;" data-info="detail.total.comments">0</a>
				</span>
				</div>
				<div style="float: left; padding-left:10px ;"><span class="mui-icon mui-icon-eye" style="color: #b8e5fa; font-size:14px ;">
					<a style=" color:#a9a9a9 ; font-size:12 ;" data-info="detail.likes">0</a></span>
				</div>
			</div>
		</div>
		
		
		<div class="li-bg-san fl-mar discuss-bg" style=" margin-bottom:0px ;">
			<div style=" overflow: hidden; margin-bottom:20px ;">	
			    <div id="member-photo" style="float: left;"></div>
				<script id="member-photo-code" type="text/html">
					<img class="img-bor-two wid" src="<%= getvarious("domain") + detail["member"]["src"] %>" style=" margin-left:0px ;" /><span class="t-p-tile"><%= detail["member"]["name"] %></span>
				</script>

			    <div style="float: right; padding-right:10px; line-height:80px; color: #666; font-size: 14px;" data-info="detail.date"></div>
			</div>

			<div class="pl_two_zi" data-info="detail.desp"></div>
			<input type="hidden" id="aid" data-info="value=detail.id" value="">
		</div>
		
		<div id="detail-photo" style=" text-align: center;"><img src="images/gif.gif" style="width: 32px; height:32px ;"></div>
		<script id="detail-photo-code" type="text/html">
			<img src="<%= getvarious("domain") + "uploads/pictures/info/imm" + detail["src"] %>">
		</script>

		
		<div class="xp-tu" style="margin-left:5px;">
			<div class="zh-good-x-p" id="heart" rel="like"><img src="images/photo-button-01.png"></div>
			<div class="zh-good-x-p" style="margin-left:10px;" id="promptBtn"><img src="images/photo-button-02.png"></div>
			<div class="zh-good-x-p" style="margin-left:10px;" onclick="shareHref()"><img src="images/photo-button-03.png"></div>
			<div class="zh-good-x-p-two"><img src="images/photo-button-04.png" style=" float: left;"><span id="likesCount" data-info="detail.likes">0</span></div>
		</div>
	
		
		<div id="detail-view"></div>
		<script id="detail-view-code" type="text/html">
			<ul id="comment-list" class="li-bg-san" style=" margin-top: 0px;">
			<% for (var i in detail["comments"]) { %>
				<li>
					<p style=" text-indent: 0px;"><b><%= detail["comments"][i]["member"]["name"] %>：</b> <%= detail["comments"][i]["content"] %></p>
				</li>
			<% } %>
			</ul>
		</script>
	</div>
	<!--右上角弹出菜单-->
	<div id="topPopover" class="mui-popover" >
		<div class="mui-popover-arrow"></div>
		<div class="mui-scroll-wrapper" style=" position: absolute; top:0px;">
			<div class="mui-scroll">
				<ul class="mui-table-view">
					<li class="mui-table-view-cell">
						<a href="publish-discuss.html" class="mui-navigate-right" data-action="openwindow">發表討論</a>
					</li>
					<li class="mui-table-view-cell"><a href="my-discuss.html" class="mui-navigate-right" data-action="openwindow">我的討論</a>
					</li>
					<li class="mui-table-view-cell"><a href="setting.html" class="mui-navigate-right" data-action="openwindow">個人主頁</a>
					</li>
					<li class="mui-table-view-cell">
					</li>
					
				</ul>
			</div>
		</div>

	</div>
	<script type="text/javascript" charset="utf-8">
		var cata_type = 4;
		var member = {};
	
		//mui初始化
		mui.init({
			swipeBack: true //启用右滑关闭功能
		});
		
		mui.plusReady(function() {
			member = myStorage.getItem("member");
			
			mui.ajax({
				type: "post",
				url: domain + "saas/info.php",
				dataType: "json",
				data: {
					action: "detail",
					where: {type: cata_type, path: getUrlParam("url")}
				},
				async: true,
				success: function(json) {
					if(!json.error) {
						if (json.detail.member) {
							jQuery("#member-photo").html(template("member-photo-code", json));
						}
						jQuery("#detail-view").html(template("detail-view-code", json));
						jQuery("#detail-photo").html(template("detail-photo-code", json));
						assignTmpl(json);
						initComment("promptBtn", "heart", "likesCount");
							
					} else {
						plus.nativeUI.toast(json.message);
					}
				},
				error: function(xhr, type, errorThrown) {}
			});
		});
	</script>
	
	
</body>
</html>