<html>
<head>
	<meta charset="utf-8">
	<title>Hello MUI</title>
	<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<!--标准mui.css-->
	<link rel="stylesheet" href="css/mui.min.css">
	<!--App自定义的css-->
	<style type="text/css">
		.mui-preview-image.mui-fullscreen {
			position: fixed;
			z-index: 20;
			background-color: #000;
		}
		.mui-preview-header,
		.mui-preview-footer {
			position: absolute;
			width: 100%;
			left: 0;
			z-index: 10;
		}
		.mui-preview-header {
			height: 44px;
			top: 0;
		}
		.mui-preview-footer {
			height: 50px;
			bottom: 0px;
		}
		.mui-preview-header .mui-preview-indicator {
			display: block;
			line-height: 25px;
			color: #fff;
			text-align: center;
			margin: 15px auto 4;
			width: 70px;
			background-color: rgba(0, 0, 0, 0.4);
			border-radius: 12px;
			font-size: 16px;
		}
		.mui-preview-image {
			display: none;
			-webkit-animation-duration: 0.5s;
			animation-duration: 0.5s;
			-webkit-animation-fill-mode: both;
			animation-fill-mode: both;
		}
		.mui-preview-image.mui-preview-in {
			-webkit-animation-name: fadeIn;
			animation-name: fadeIn;
		}
		.mui-preview-image.mui-preview-out {
			background: none;
			-webkit-animation-name: fadeOut;
			animation-name: fadeOut;
		}
		.mui-preview-image.mui-preview-out .mui-preview-header,
		.mui-preview-image.mui-preview-out .mui-preview-footer {
			display: none;
		}
		.mui-zoom-scroller {
			position: absolute;
			display: -webkit-box;
			display: -webkit-flex;
			display: flex;
			-webkit-box-align: center;
			-webkit-align-items: center;
			align-items: center;
			-webkit-box-pack: center;
			-webkit-justify-content: center;
			justify-content: center;
			left: 0;
			right: 0;
			bottom: 0;
			top: 0;
			width: 100%;
			height: 100%;
			margin: 0;
			-webkit-backface-visibility: hidden;
		}
		.mui-zoom {
			-webkit-transform-style: preserve-3d;
			transform-style: preserve-3d;
		}
		.mui-slider .mui-slider-group .mui-slider-item img {
			width: auto;
			height: auto;
			max-width: 100%;
			max-height: 100%;
		}
		.mui-android-4-1 .mui-slider .mui-slider-group .mui-slider-item img {
			width: 100%;
		}
		.mui-android-4-1 .mui-slider.mui-preview-image .mui-slider-group .mui-slider-item {
			display: inline-table;
		}
		.mui-android-4-1 .mui-slider.mui-preview-image .mui-zoom-scroller img {
			display: table-cell;
			vertical-align: middle;
		}
		.mui-preview-loading {
			position: absolute;
			width: 100%;
			height: 100%;
			top: 0;
			left: 0;
			display: none;
		}
		.mui-preview-loading.mui-active {
			display: block;
		}
		.mui-preview-loading .mui-spinner-white {
			position: absolute;
			top: 50%;
			left: 50%;
			margin-left: -25px;
			margin-top: -25px;
			height: 50px;
			width: 50px;
		}
		.mui-preview-image img.mui-transitioning {
			-webkit-transition: -webkit-transform 0.5s ease, opacity 0.5s ease;
			transition: transform 0.5s ease, opacity 0.5s ease;
		}
		@-webkit-keyframes fadeIn {
			0% {
				opacity: 0;
			}
			100% {
				opacity: 1;
			}
		}
		@keyframes fadeIn {
			0% {
				opacity: 0;
			}
			100% {
				opacity: 1;
			}
		}
		@-webkit-keyframes fadeOut {
			0% {
				opacity: 1;
			}
			100% {
				opacity: 0;
			}
		}
		@keyframes fadeOut {
			0% {
				opacity: 1;
			}
			100% {
				opacity: 0;
			}
		}
		p img {
			max-width: 100%;
			height: auto;
		}
		.mui-content-padded p{ margin-bottom:0px;}
		#comment-list {
			width:95%;
			padding:5px 0px 5px 0px;
			background-color:#fff ;
			text-align: left;
			
			color:#666 ;
			font-size:14px ;
			margin:0px 0px ;
			margin:0 auto;
		}
		#comment-list li {
			border-bottom: 1px  solid #ebebed; list-style:none ; background-color: #f8f8f9; padding-left: 5px; height:28px;
		}
		#comment-list li p{color:#666;}
	</style>

	<script src="js/mui.min.js"></script>
	<script src="js/mui.zoom.js"></script>
	<script src="js/mui.previewimage.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/template-native.js"></script>
    <script src="js/basic.js"></script>
</head>

<body>
	<header class="mui-bar mui-bar-nav">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"><img src="images/home.png"></a>
	    <h1 class="mui-title"><img src="images/Petchat.png"> <img src="images/CatDog.png"></h1>
	    <div style="float: right; margin-top: 10px; font-weight: 600; color: #333;">登出</div>
	</header>
	<div class="mui-content" style="background:none ;">
		<div class="mui-content-padded" id="detail-view"></div>
		<script id="detail-view-code" type="text/html">
			<p>
				<img src="<%= getvarious("domain") + "uploads/pictures/info/imm" + detail["src"] %>" data-preview-src="" data-preview-group="1" />
			</p>
			<p><%=# detail["desp"] %></p>
			
		</script>
		<div style=" text-align: right; margin-right: 10px;" id='promptBtn'><img src="images/ioc-01.png" style="width:20px;"></div>
		<ul id="comment-list"></ul>
			<script id="comment-list-code" type="text/html">
			<% for (var i in list) { %>
				<li>
					<p><b><%= list[i]["member"]["name"] %>：</b> <%= list[i]["content"] %></p>
					
				</li>
			<% } %>
			</script>
		</div>
	</div>

	<script>
		(function($, doc) {
			var loadComment = function() {
				$.ajax({
					type: "post",
					url: domain + "saas/message.php",
					dataType: "json",
					data: {
						action: "list",
						where: {path: getUrlParam("url")}
					},
					async: true,
					success: function(json) {
						if(!json.error) {
							jQuery("#list-view").html(template('list-view-code', json));
							assignTmpl(json);
						}
					},
					error: function(xhr, type, errorThrown) {

					}
				});
			}

			$.plusReady(function() {
				$.ajax({
					type: "post",
					url: domain + "saas/info.php",
					dataType: "json",
					data: {
						action: "detail",
						where: {path: getUrlParam("url")}
					},
					async: true,
					success: function(json) {
						if(!json.error) {
							jQuery("#detail-view").html(template('detail-view-code', json));
							$.previewImage();
							//loadComment();

							jQuery("[data-action='comment']").click(function(){
								var content = $(this).parent().find("textarea").html();

								if (content) {
									var member = myStorage.getItem("member");
									var target = $(this).parent().find("textarea").attr("data-sign");

									$.ajax({
										type: "post",
										url: domain + "saas/message.php",
										dataType: "json",
										data: {
											action: "insert",
											params: {
												aid: target,
												atype: 3,
												mid: member.id,
												content: content,
												type: 1
											}
										},
										async: true,
										success: function(json) {
											if(!json.error) {

												
											} else {
												//plus.nativeUI.toast(json.message);
											}
										},
										error: function(xhr, type, errorThrown) {}
									});
								}
							});
							
						} else {
							plus.nativeUI.toast(json.message);
						}
					},
					error: function(xhr, type, errorThrown) {

					}
				});
			});
		}(mui, document));
	</script>
	<script type="text/javascript" charset="utf-8">
		var member = myStorage.getItem("member");
	
		//mui初始化
		mui.init({
			swipeBack: true //启用右滑关闭功能
		});
		
		mui.plusReady(function() {
			mui.ajax({
				type: "post",
				url: domain + "saas/message.php",
				dataType: "json",
				data: {
					action: "list",
					where: {type: 4}
				},
				async: true,
				success: function(json) {
					if(!json.error) {
						jQuery("#comment-list").html(template('comment-list-code', json));
							
					} else {
						plus.nativeUI.toast(json.message);
					}
				},
				error: function(xhr, type, errorThrown) {}
			});
		});

		document.getElementById("promptBtn").addEventListener("tap", function(e) {
			e.detail.gesture.preventDefault(); //修复iOS 8.x平台存在的bug，使用plus.nativeUI.prompt会造成输入法闪一下又没了
			mui.prompt('請輸入您的評語：', '', '', ['取消', '提交'], function(e) {
				if (e.index == 1) {
					mui.ajax({
						type: "post",
						url: domain + "saas/message.php",
						dataType: "json",
						data: {
							action: "send",
							id: member.id,
							name: member.name,
							content: e.value,
							type: 4
						},
						async: true,
						success: function(json) {
							//alert(JSON.stringify(json))
						},
						error: function(xhr, type, errorThrown) {
							//alert(JSON.stringify(xhr))
						}
					});
					
					jQuery("#comment-list").append("<li><p><b>" + member.name + "：</b></p><p>" + e.value + "</p></li>");
				}
			})
		});

		$(document).ready(function() {
			$('body').on("click", '.heart', function() {
				var A=$(this).attr("id");
				var B=A.split("like");
				var messageID=B[1];
				var C=parseInt($("#likeCount"+messageID).html());
				$(this).css("background-position","")
				var D=$(this).attr("rel");
			   
				if(D === 'like') {      
					$("#likeCount"+messageID).html(C+1);
					$(this).addClass("heartAnimation").attr("rel","unlike");
				} else {
					$("#likeCount"+messageID).html(C-1);
					$(this).removeClass("heartAnimation").attr("rel","like");
					$(this).css("background-position","left");
				}
			});
		});
	</script>
</body>
</html>