<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Hello MUI</title>
	<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">

	<link rel="stylesheet" href="css/mui.min.css">
	<link rel="stylesheet" type="text/css" href="css/feedback-page.css" />

	<script src="js/mui.min.js "></script>
	<script src="js/mui.view.js "></script>
    <script src="js/jquery.min.js"></script>
	<script src='libs/easymob-webim-sdk/strophe-custom-2.0.0.js'></script>
	<script src='libs/easymob-webim-sdk/json2.js'></script>
	<script src="libs/easymob-webim-sdk/easemob.im-1.0.5.js"></script>
	<script src="js/mui.locker.js"></script>
    <script src="js/basic.js"></script>
</head>

<body class="mui-fullscreen">
	<header class="mui-bar mui-bar-nav">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"><img src="images/home.png"></a>
		<h1 class="mui-title"><img src="images/Petchat.png"> <img src="images/CatDog.png"></h1>
		<div style=" float: right; margin-top: 10px; font-weight: 600; color: #333;">登出</div>
	</header>

	<!--页面主结构开始-->
	<div id="app" class="mui-views">
		<div class="mui-view">
			<div class="mui-navbar">
			</div>
			<div class="mui-pages">
			</div>
		</div>
	</div>
	<!--页面主结构结束-->
	<!--单页面开始-->
	<div id="setting" class="mui-page">
		
		<!--页面标题栏开始-->
		<div class="mui-navbar-inner mui-bar mui-bar-nav">
			
		</div>
		<!--页面标题栏结束-->
		<!--页面主内容区开始-->
		<div class="mui-page-content">
			<div class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<ul class="mui-table-view mui-table-view-chevron">
						<li class="mui-table-view-cell mui-media">
							<a class="mui-navigate-right" href="#account">
								<img class="mui-media-object mui-pull-left head-img" id="head-img" src="images/user-photo.png"  data-before-info="domain" data-info="src=member.src" />
								<div class="mui-media-body">
									<span data-info="member.name"></span>
									<p class='mui-ellipsis'>賬號: <span data-info="member.name"></span></p>
								</div>
							</a>
						</li>
					</ul>
					<ul class="mui-table-view mui-table-view-chevron">
						<li class="mui-table-view-cell">
							<a href="#account" class="mui-navigate-right">賬號與安全</a>
						</li>
					</ul>
					
	                <ul class="mui-table-view mui-table-view-chevron">
						<li class="mui-table-view-cell">
							<a href="#about" class="mui-navigate-right">關於Petchat <i class="mui-pull-right update">V1.0.1</i></a>
						</li>
					</ul>
					<ul class="mui-table-view">
						<li class="mui-table-view-cell" style="text-align: center;">
							<a href="login.html?action=logout" data-action="openwindow">退出登錄</a>
						</li>
					</ul>
				</div>
			</div>
		</div>
		<!--页面主内容区结束-->
	</div>
	<!--单页面结束-->

	<div id="account" class="mui-page">
		<div class="mui-navbar-inner mui-bar mui-bar-nav">
			
		</div>
		<div class="mui-page-content">
			<div class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<ul class="mui-table-view">
						<li class="mui-table-view-cell">
							<a id="head" class="mui-navigate-right">頭像
							<span class="mui-pull-right head">
								<img class="head-img mui-action-preview" id="head-img1" src="images/user-photo.png" data-before-info="domain" data-info="src=member.src" />
							</span>
						</a>
						</li>
						<li class="mui-table-view-cell">
							<a>姓名<span class="mui-pull-right" data-info="member.name"></span></a>
						</li>
						<li class="mui-table-view-cell">
							<a>手機號<span class="mui-pull-right" data-info="member.phone"></span></a>
						</li>
						<li class="mui-table-view-cell">
							<a>郵箱<span class="mui-pull-right" data-info="member.email"></span></a>
						</li>
						<li class="mui-table-view-cell">
							<a>地址<span class="mui-pull-right" data-info="member.address"></span></a>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</div>

	<div id="about" class="mui-page">
		<div class="mui-navbar-inner mui-bar mui-bar-nav">
			<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
				<span class="mui-icon mui-icon-left-nav"></span>设置/
			</button>
			<h1 class="mui-center mui-title">关于Petchat</h1>
		</div>
		<div class="mui-page-content">
			<div class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<ul class="mui-table-view">
						<li class="mui-table-view-cell mui-plus-visible">
							<a href="" data-action="openwindow" class="mui-navigate-right">欢迎页</a>
						</li>
						<li class="mui-table-view-cell mui-plus-visible">
							<a id="share" class="mui-navigate-right">分享推荐</a>
						</li>
						<li class="mui-table-view-cell">
							<a id="tel" class="mui-navigate-right">客服电话</a>
						</li>
						<li class="mui-table-view-cell mui-plus-visible">
							<a id="update" class="mui-navigate-right">检查更新</a>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</div>

	<script>
	mui.init();
	//初始化单页view
	var viewApi = mui('#app').view({
		defaultPage: '#setting'
	});

	//初始化单页的区域滚动
	mui('.mui-scroll-wrapper').scroll();

	//分享操作
	var shares = {};
	var member = myStorage.getItem("member");

	mui.plusReady(function() {
		mui.ajax({
			type: "post",
			url: domain + "saas/member.php",
			dataType: "json",
			data: {
				action: "profile",
				name: member.name,
				id: member.id
			},
			async: true,
			success: function(json) {
				if(!json.error) {
					assignTmpl(json);
					initImgPreview();
					
				} else {
					plus.nativeUI.toast(json.message);
				}
			},
			error: function(xhr, type, errorThrown) {

			}
		});

		plus.share.getServices(function(s) {
			if (s && s.length > 0) {
				for (var i = 0; i < s.length; i++) {
					var t = s[i];
					shares[t.id] = t;
				}
			}
		}, function() {
			console.log("获取分享服务列表失败");
		});
	});

	setTimeout(function () {
		initImgPreview();
	}, 500);

	//分享链接点击事件
	document.getElementById("share").addEventListener('tap', function() {
		var ids = [{
				id: "weixin",
				ex: "WXSceneSession"
			}, {
				id: "weixin",
				ex: "WXSceneTimeline"
			}, {
				id: "sinaweibo"
			}, {
				id: "tencentweibo"
			}, {
				id: "qq"
			}],
			bts = [{
				title: "发送给微信好友"
			}, {
				title: "分享到微信朋友圈"
			}, {
				title: "分享到新浪微博"
			}, {
				title: "分享到腾讯微博"
			}, {
				title: "分享到QQ"
			}];
		plus.nativeUI.actionSheet({
			cancel: "取消",
			buttons: bts
		}, function(e) {
			var i = e.index;
			if (i > 0) {
				var s_id = ids[i - 1].id;
				var share = shares[s_id];
				if (share) {
					if (share.authenticated) {
						shareMessage(share, ids[i - 1].ex);
					} else {
						share.authorize(function() {
							shareMessage(share, ids[i - 1].ex);
						}, function(e) {
							console.log("认证授权失败：" + e.code + " - " + e.message);
						});
					}
				} else {
					mui.toast("无法获取分享服务，请检查manifest.json中分享插件参数配置，并重新打包")
				}
			}
		});
	});

	function shareMessage(share, ex) {
		var msg = {
			extra: {
				scene: ex
			}
		};
		msg.href = "http://www.dcloud.io/hellomui/";
		msg.title = "最接近原生APP体验的高性能前端框架";
		msg.content = "我正在体验HelloMUI，果然很流畅，基本看不出和原生App的差距";
		if (~share.id.indexOf('weibo')) {
			msg.content += "；体验地址：http://www.dcloud.io/hellomui/";
		}
		msg.thumbs = ["_www/images/logo.png"];
		share.send(msg, function() {
			console.log("分享到\"" + share.description + "\"成功！ ");
		}, function(e) {
			console.log("分享到\"" + share.description + "\"失败: " + e.code + " - " + e.message);
		});
	}

	//客服电话
	document.getElementById("tel").addEventListener('tap', function() {
		if(mui.os.plus){
			plus.device.dial("14714529086");
		} else {
			location.href = 'tel:14714529086';
		}
	});

	//检查更新
	document.getElementById("update").addEventListener('tap', function() {
		var server = "http://www.dcloud.io/check/update"; //获取升级描述文件服务器地址
		mui.getJSON(server, {
			"appid": plus.runtime.appid,
			"version": plus.runtime.version,
			"imei": plus.device.imei
		}, function(data) {
			if (data.status) {
				plus.ui.confirm(data.note, function(i) {
					if (0 == i) {
						plus.runtime.openURL(data.url);
					}
				}, data.title, ["立即更新", "取　　消"]);
			} else {
				mui.toast('Petchat 已是最新版本~')
			}
		});
	});

	var view = viewApi.view;
	(function($) {
		//处理view的后退与webview后退
		var oldBack = $.back;
		$.back = function() {
			if (viewApi.canBack()) { //如果view可以后退，则执行view的后退
				viewApi.back();
			} else { //执行webview后退
				oldBack();
			}
		};
		
		//监听页面切换事件方案1,通过view元素监听所有页面切换事件，目前提供pageBeforeShow|pageShow|pageBeforeBack|pageBack四种事件(before事件为动画开始前触发)
		//第一个参数为事件名称，第二个参数为事件回调，其中e.detail.page为当前页面的html对象
		view.addEventListener('pageBeforeShow', function(e) {
			//				console.log(e.detail.page.id + ' beforeShow');
		});
		view.addEventListener('pageShow', function(e) {
			//				console.log(e.detail.page.id + ' show');
		});
		view.addEventListener('pageBeforeBack', function(e) {
			//				console.log(e.detail.page.id + ' beforeBack');
		});
		view.addEventListener('pageBack', function(e) {
			//				console.log(e.detail.page.id + ' back');
		});
	})(mui);
	
	//更换头像
	mui(".mui-table-view-cell").on("tap", "#head", function(e) {
		if(mui.os.plus){
			var a = [{
				title: "从手机相册选择"
			}];
			plus.nativeUI.actionSheet({
				title: "修改头像",
				cancel: "取消",
				buttons: a
			}, function(b) {
				switch (b.index) {
					case 0:
						break;
					case 1:
						getGalleryImg();
						break;
					default:
						break
				}
			})	
		}
		
	});

	/*
	function getImage() {
		var c = plus.camera.getCamera();
		c.captureImage(function(e) {
			plus.io.resolveLocalFileSystemURL(e, function(entry) {
				var s = entry.toLocalURL() + "?version=" + new Date().getTime();
				console.log(s);
				document.getElementById("head-img").src = s;
				document.getElementById("head-img1").src = s;
				//变更大图预览的src
				//目前仅有一张图片，暂时如此处理，后续需要通过标准组件实现
				document.querySelector("#__mui-imageview__group .mui-slider-item img").src = s + "?version=" + new Date().getTime();;;
			}, function(e) {
				console.log("读取拍照文件错误：" + e.message);
			});
		}, function(s) {
			console.log("error" + s);
		}, {
			filename: "_doc/head.jpg"
		})
	}
	*/

	function getGalleryImg() {
		plus.gallery.pick(function(path) {
			uploadFile(path, function(res) {
				assignTmpl(res);
				initImgPreview();				
			});
		});
	};

	document.getElementById("head-img1").addEventListener('tap', function(e) {
		e.stopPropagation();
	});

	function initImgPreview() {
		var imgs = document.querySelectorAll("img.mui-action-preview");
		imgs = mui.slice.call(imgs);
		if (imgs && imgs.length > 0) {
			if (document.getElementById("__mui-imageview__")) {
				document.body.removeChild(document.getElementById("__mui-imageview__"));
			}
			
			var slider = document.createElement("div");
			slider.setAttribute("id", "__mui-imageview__");
			slider.classList.add("mui-slider");
			slider.classList.add("mui-fullscreen");
			slider.style.display = "none";
			slider.addEventListener("tap", function() {
				slider.style.display = "none";
			});
			slider.addEventListener("touchmove", function(event) {
				event.preventDefault();
			});
			var slider_group = document.createElement("div");
			slider_group.setAttribute("id", "__mui-imageview__group");
			slider_group.classList.add("mui-slider-group");
			imgs.forEach(function(value, index, array) {
				//给图片添加点击事件，触发预览显示；
				value.addEventListener('tap', function() {
					slider.style.display = "block";
					_slider.refresh();
					_slider.gotoItem(index, 0);
				})
				var item = document.createElement("div");
				item.classList.add("mui-slider-item");
				var a = document.createElement("a");
				var img = document.createElement("img");
				img.setAttribute("src", value.src);
				a.appendChild(img)
				item.appendChild(a);
				slider_group.appendChild(item);
			});
			slider.appendChild(slider_group);
			document.body.appendChild(slider);
			var _slider = mui(slider).slider();
		}
	}
	</script>

</body>
</html>